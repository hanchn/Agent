## **第十节 · 循环与批量生成**

### 1. 学习目标

* 理解循环（Loop）在 Coze Flow 中的作用
* 学会让 Flow 支持批量输入多个主题
* 能结合平台、风格等条件实现多维组合生成
* 掌握批量结果的合并与输出方法
* 支持批产内容直接导出到表格/数据库/API

---

### 2. 课程讲解

#### 2.1 为什么需要循环

* 节省人工操作：一次运行输出多条内容
* 保证批量内容格式一致：方便导入 CMS 或表格
* 提高产能：适合短视频、广告、商品文案批量生成

#### 2.2 循环的两种模式

| 模式         | 场景              | 示例              |
| ---------- | --------------- | --------------- |
| **单层循环**   | 一个列表变量，逐项执行同一流程 | 批量生成不同主题的抖音脚本   |
| **多层嵌套循环** | 多个列表组合，生成笛卡尔积结果 | 多平台 × 多风格 × 多主题 |

---

### 3. 步骤演示（单层循环）

#### 目标

让“抖音脚本生成流程”一次生成多个主题的脚本。

---

**步骤 1：修改输入节点**

* 字段：

  * 变量名：`topics`
  * 类型：数组（List of String）
  * 占位提示：`请输入多个主题，如 ["夏季防晒穿搭", "小个子显高技巧"]`

---

**步骤 2：添加循环节点**

1. 在 Flow 中插入 **Loop 节点**
2. 循环列表：`{{topics}}`
3. 循环变量名：`topic`

---

**步骤 3：循环体内逻辑**

* **KB 节点**：检索关键词用 `{{topic}}`
* **LLM 节点**：

  ```
  你是一名资深短视频编导。主题：{{topic}}
  品牌资料：
  {{kb_results}}
  输出 JSON：
  {
    "topic": "{{topic}}",
    "title": "",
    "hook": "",
    "shots": [
      {"scene": "镜头1", "description": ""},
      {"scene": "镜头2", "description": ""}
    ],
    "hashtags": []
  }
  ```

---

**步骤 4：收集结果**

* 在循环节点外，使用 **Aggregate 节点** 合并所有 `script_json` 到数组变量 `scripts_list`

---

**步骤 5：输出结果**

* Output 节点绑定 `{{scripts_list}}`
* 可选：在后置节点将数组转成 CSV 或表格

---

### 4. 步骤演示（多层循环）

#### 目标

批量生成 **多主题 × 多平台** 内容。

---

**步骤 1：输入参数**

```json
{
  "topics": ["夏季防晒穿搭", "旅行收纳技巧"],
  "platforms": ["douyin", "xiaohongshu"]
}
```

---

**步骤 2：双层循环**

* 外层循环：`{{topics}}` → 变量 `topic`
* 内层循环：`{{platforms}}` → 变量 `platform`

---

**步骤 3：在内层逻辑中处理平台分支**

* Condition 节点根据 `platform` 走不同 Prompt 模板
* 输出 JSON：

  ```json
  {
    "topic": "{{topic}}",
    "platform": "{{platform}}",
    "title": "",
    "content": "",
    "hashtags": []
  }
  ```

---

**步骤 4：结果收集与导出**

* 将所有结果合并到 `final_list`
* 可添加 **HTTP 节点** 调用外部 API，将批产结果直接推送到 CMS、飞书文档或 Google Sheet

---

### 5. 最佳实践

* **并发优化**：如果 API 支持并行，可减少批量延迟
* **输出格式统一**：多维组合结果必须符合相同 Schema
* **分批运行**：大量主题可分批执行，避免超时
* **可恢复运行**：记录已生成的组合，避免重复计算

---

### 6. 实操案例

**案例目标**
批量生成新品推广文案，覆盖两个平台和三种风格。

**输入参数**：

```json
{
  "products": ["夏季防晒帽", "便携保温杯"],
  "platforms": ["douyin", "xiaohongshu"],
  "styles": ["funny", "professional", "story"]
}
```

**逻辑**：

* 三层循环生成产品 × 平台 × 风格组合
* Prompt 内动态替换变量
* 结果推送到 Google Sheet

---

### 7. 课后作业

1. 修改你的“抖音脚本生成流程”，支持一次输入多个主题并批量输出
2. 增加平台和风格两个变量，支持多维组合批产
3. 将批量结果导出为 CSV 文件
4. 测试不少于 6 个组合，验证输出格式一致性
5. 截图你的 Flow 结构与运行结果

