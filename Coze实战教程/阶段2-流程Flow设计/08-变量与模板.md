## **第八节 · 输出格式与结构化数据**

### 1. 学习目标

* 理解为什么 AI 输出必须结构化
* 掌握在 Coze Flow 中控制 LLM 输出格式的方法
* 学会生成 JSON、Markdown、CSV 等格式的结果
* 能用 Schema 校验生成结果，确保稳定可用
* 为后续自动化生产 → 系统导入打好基础

---

### 2. 课程讲解

#### 2.1 为什么需要结构化输出

* **机器可读**：方便后续系统直接解析（CMS、视频编辑工具）
* **减少后处理**：避免人工清洗文本
* **稳定性**：防止生成内容漏字段、错字段
* **一致性**：不同批次的输出可直接对比、统计

#### 2.2 常见结构化格式

| 格式       | 场景        | 优点     | 缺点        |
| -------- | --------- | ------ | --------- |
| JSON     | 数据交换、接口传输 | 标准、易解析 | 不适合长文本排版  |
| Markdown | 内容展示、富文本  | 兼容性好   | 解析需额外处理   |
| CSV      | 表格数据、批量导入 | 简单、轻量  | 不能直接存复杂结构 |
| HTML     | 网页展示      | 样式可控   | 繁琐、易出错    |

#### 2.3 Coze 中的结构化输出控制方式

1. **Prompt 明确要求**

   * 用代码块 ` ```json ... ``` ` 强制输出 JSON
   * 指定字段、类型、嵌套结构
2. **Schema 校验**

   * Flow 节点配置 Schema
   * 生成结果不符合 Schema → 自动重试或报错
3. **后置解析节点**

   * LLM 输出 → 解析/转换节点 → 统一输出

---

### 3. 步骤演示（以 JSON 输出为例）

#### 目标

让“抖音脚本生成流程”的输出严格符合以下 JSON Schema：

```json
{
  "title": "string",
  "hook": "string",
  "shots": [
    {"scene": "string", "description": "string"}
  ],
  "hashtags": ["string"]
}
```

---

**步骤 1：修改 LLM 节点 Prompt**

```
你是一名资深短视频编导。根据主题和品牌资料，生成抖音短视频脚本。
严格按照以下 JSON 格式输出：
{
  "title": "",
  "hook": "",
  "shots": [
    {"scene": "", "description": ""}
  ],
  "hashtags": []
}

禁止添加多余文字或解释。
```

---

**步骤 2：在节点中配置 Schema 校验**

1. 选中 LLM 节点
2. 打开 **Output Schema**
3. 定义字段及类型：

   * `title`：string
   * `hook`：string
   * `shots`：array → object（scene: string, description: string）
   * `hashtags`：array(string)

---

**步骤 3：处理生成失败**

* 设置 **重试次数** = 2
* 如果仍不符合 → 输出错误提示：`生成失败，请重试`

---

**步骤 4：测试**

1. 输入：`夏季防晒穿搭`
2. 检查输出是否为有效 JSON
3. 用 JSON 校验工具验证

---

**步骤 5：可选 - 同时输出 Markdown**

* 在 Flow 添加一个后置节点，将 JSON 转为 Markdown：

  ```
  # {{title}}
  **开场钩子**：{{hook}}

  ## 分镜
  {% for shot in shots %}
  - **{{shot.scene}}**：{{shot.description}}
  {% endfor %}

  **话题标签**：{{hashtags | join(", ")}}
  ```

---

### 4. 最佳实践

* **字段命名统一**：方便后续批量处理
* **数组固定结构**：避免空数组或多层嵌套混乱
* **引文单独字段**：如果是 RAG 应用，引用资料要放在 `citations` 字段
* **多格式输出**：JSON 用于机器处理，Markdown/HTML 用于人工查看

---

### 5. 实操案例

**案例目标**
生成一个多平台可用的脚本输出，支持抖音、小红书两个平台，结构统一。

**Schema 示例**

```json
{
  "platform": "string",
  "title": "string",
  "hook": "string",
  "content": "string",
  "hashtags": ["string"]
}
```

**流程要点**

1. 输入平台参数：`platform`（枚举：douyin, xiaohongshu）
2. Prompt 中动态引用平台
3. 输出 JSON 严格符合 Schema
4. 绑定 Schema 校验，确保字段完整

---

### 6. 课后作业

1. 修改你的“抖音脚本生成流程”，为输出添加 Schema 校验
2. 增加字段 `citations`（数组，存 KB 引文）
3. 测试 3 个不同主题，验证输出是否总是符合 Schema
4. 将 JSON 转换为 Markdown，方便人工审核
5. 记录一次生成失败的情况，并分析原因

