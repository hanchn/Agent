# 认识 Flow

## 学习目标
- 理解Flow的基本概念
- 掌握各种节点类型的使用
- 学会设计简单的自动化流程

## Flow 基础概念
### 什么是Flow
- 可视化工作流设计工具
- 自动化任务执行引擎
- 与Bot的协作关系

### Flow的优势
- 无代码/低代码开发
- 可视化流程设计
- 灵活的数据处理能力

## 节点类型详解
### 输入节点
- **文本输入**：接收用户输入的文本
- **文件输入**：处理上传的文件
- **API输入**：接收外部API数据
- **定时触发**：按时间自动执行

### 处理节点
- **文本生成**：使用LLM生成内容
- **数据转换**：格式转换和数据清洗
- **条件判断**：根据条件分支执行
- **循环处理**：批量处理数据

### 工具节点
- **HTTP请求**：调用外部API
- **数据库操作**：读写数据库
- **文件操作**：文件的读取和保存
- **通知推送**：发送消息通知

### 输出节点
- **文本输出**：返回处理结果
- **文件输出**：生成文件下载
- **API响应**：返回API格式数据
- **界面显示**：在用户界面展示结果

## 数据传递机制
### 变量系统
- 全局变量
- 局部变量
- 环境变量

### 数据流向
- 节点间的数据传递
- 数据格式转换
- 错误处理机制

## 实践练习
### 练习1：创建第一个Flow
- 设计简单的文本处理流程
- 配置输入和输出节点
- 测试流程执行

### 练习2：数据处理Flow
- 使用条件分支
- 实现数据转换
- 添加错误处理

## 最佳实践
- Flow设计原则
- 性能优化建议
- 调试技巧

## 常见问题
- 节点配置错误
- 数据传递失败
- 性能问题排查


-------------------


## **第六节 · 调用外部 API**

### 1. 学习目标

* 理解在 Flow 中调用外部 API 的意义与应用场景
* 学会在 Coze 创建自定义 Tool（外部接口封装）
* 能在 Flow 中将 API 返回的数据作为变量传入 LLM
* 掌握 API 安全配置（密钥、限流、鉴权）

---

### 2. 课程讲解

#### 2.1 为什么要调用外部 API

* **实时性**：获取最新的热点、库存、价格、天气等
* **数据补充**：扩充 KB 以外的即时信息
* **任务执行**：让 Bot 不仅能说，还能“做”（发消息、下单、查询系统）

#### 2.2 API 调用在 Coze 的三种方式

| 方式             | 场景                 | 优缺点              |
| -------------- | ------------------ | ---------------- |
| **内置 HTTP 节点** | 无需写代码，直接调用 API     | 简单，但灵活性有限        |
| **自研 Tool**    | 封装 API 逻辑并注册到 Coze | 可复用、可加安全逻辑，但需写代码 |
| **外部服务代理**     | 通过自家后端转发请求         | 完全可控，适合敏感数据场景    |

#### 2.3 本节案例

调用一个 **抖音热搜 API**，把前 5 条热点关键词注入到脚本生成 Prompt 中，让 Bot 自动结合热点创作。

---

### 3. 步骤演示（用自研 Tool 调 API）

#### 步骤 1：编写 API 封装

假设我们有一个简单的抖音热搜 API：

```
GET https://api.example.com/douyin/hot
Headers:
  Authorization: Bearer <API_KEY>
```

**Node.js Tool 示例**

```js
import axios from "axios";

export default async function getDouyinHotTopics() {
  const res = await axios.get("https://api.example.com/douyin/hot", {
    headers: { Authorization: `Bearer ${process.env.DOUYIN_API_KEY}` }
  });
  // 返回前5条关键词
  return res.data.topics.slice(0, 5);
}
```

---

#### 步骤 2：注册到 Coze

1. 进入 Coze 左侧菜单 → **Tools**
2. 点击 **Create Tool**
3. 填写：

   * 名称：`get_douyin_hot`
   * 描述：获取当前抖音热搜前 5 条
   * 输入参数：无
   * 输出格式：

     ```json
     { "topics": ["关键词1", "关键词2", ...] }
     ```
4. 上传你的 Tool 代码（或提供 API Endpoint）
5. 保存并测试 Tool

---

#### 步骤 3：在 Flow 中调用

1. 打开 `抖音脚本生成流程`
2. 在 **Input** 节点后添加 **Tool 调用节点**
3. 选择 `get_douyin_hot` Tool
4. 输出变量：`hot_topics`

---

#### 步骤 4：改写 LLM 节点 Prompt

```
你是一名资深短视频编导。结合以下品牌资料、主题和抖音热搜关键词，生成一条抖音短视频脚本：
主题：{{topic}}
抖音热搜：{{hot_topics}}
品牌资料：
{{kb_results}}

输出 JSON 格式：
{
  "title": "",
  "hook": "",
  "shots": [
    {"scene": "镜头1", "description": ""},
    {"scene": "镜头2", "description": ""}
  ],
  "hashtags": []
}
```

---

#### 步骤 5：测试运行

1. 在 Flow 的 Test 模式输入：

   ```
   夏季防晒穿搭
   ```
2. 检查输出脚本是否自动融合了热搜关键词
3. 确认 JSON 结构完整

---

### 4. API 安全要点

* **密钥管理**：不要把 API Key 写死在代码里，用环境变量
* **限流**：防止 Bot 高频调用导致 API 封禁
* **错误处理**：API 失败时返回默认数据，避免流程中断
* **数据过滤**：对外部 API 返回的数据做合规审查（敏感词、低质量内容）

---

### 5. 实操案例

**案例目标**
给“新品上市文案助手”增加微博热搜数据，让文案标题更贴近热点。

**步骤**

1. 编写 `get_weibo_hot` Tool
2. 注册到 Coze
3. 在 Flow 中调用该 Tool
4. 将返回的前 3 条热搜注入文案生成 Prompt
5. 测试 3 次不同产品输入，验证标题是否包含热点元素

---

### 6. 课后作业

1. 找一个你业务相关的免费 API（天气、汇率、新闻等）
2. 封装成自研 Tool 并注册到 Coze
3. 在 Flow 中调用并传入 LLM
4. 测试 3 组输入，记录调用成功率和延迟
5. 写一段 50 字的总结：该 API 如何提升你的 Bot 能力


