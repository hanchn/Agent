## **第十四节 · 流程监控与错误告警**

### 1. 学习目标

* 理解为什么 AI 内容生产流程需要监控
* 学会在 Coze Flow 中捕获错误与异常
* 掌握自动化告警的实现方式（飞书 / 邮件 / 短信）
* 能实现错误分级处理：自动修复、重试、人工处理
* 建立流程运行日志与性能指标

---

### 2. 课程讲解

#### 2.1 为什么要做监控

* **无人值守运行需要“眼睛”**：业务中断会造成直接损失
* **快速响应问题**：尽早修复，减少影响面
* **持续优化**：通过日志分析找到性能瓶颈与失败高发点

---

#### 2.2 常见的错误类型

| 类型        | 示例                | 处理方式         |
| --------- | ----------------- | ------------ |
| **生成错误**  | 模型返回空值 / 格式错误     | 重试或更换模型      |
| **质检不通过** | 字段缺失 / 敏感词        | 自动修正重试       |
| **发布失败**  | API 超时 / Token 过期 | 刷新 Token 后重试 |
| **流程超时**  | 多层循环卡死            | 终止并记录        |
| **数据异常**  | KB 查询为空           | 用默认模板        |

---

#### 2.3 Coze 中的错误捕获方法

1. **Try-Catch 节点**

   * 在可能失败的节点外层包裹 Try 节点
   * Catch 分支中执行告警或重试
2. **条件判断**

   * 检查变量是否为空或返回码是否非 200
   * 根据结果走错误处理分支
3. **超时控制**

   * 设定节点执行时间上限
   * 超时进入错误分支

---

### 3. 步骤演示（飞书告警）

#### 目标

当流程任一步失败时，自动发飞书群消息通知运维人员。

---

**步骤 1：封装告警节点**

* 节点类型：HTTP Request
* URL：飞书自定义机器人 Webhook
* Header：

  ```
  Content-Type: application/json
  ```
* Body：

  ```json
  {
    "msg_type": "text",
    "content": {
      "text": "[告警] 流程失败\n步骤: {{error_step}}\n原因: {{error_message}}\n时间: {{now}}"
    }
  }
  ```

---

**步骤 2：在 Catch 分支中调用告警节点**

* 变量：

  * `error_step`：失败节点的名称
  * `error_message`：失败返回的错误信息
  * `now`：当前时间

---

**步骤 3：错误分级处理**

| 级别    | 场景              | 处理方式           |
| ----- | --------------- | -------------- |
| **低** | 质检不通过           | 自动修正重试         |
| **中** | API 超时          | 重试 1 次，失败则人工介入 |
| **高** | Access Token 失效 | 立即告警并阻断流程      |

---

**步骤 4：性能监控**

* 在每个关键节点后添加日志记录：

  * 开始时间 / 结束时间 → 计算耗时
  * 输入大小 / 输出大小
  * 是否重试
* 定期统计：

  * 成功率（成功运行次数 / 总运行次数）
  * 平均延迟
  * 各节点耗时占比

---

### 4. 高级玩法

* **可视化监控面板**

  * 将日志推送到 Elasticsearch + Kibana 或飞书多维表格，实时查看
* **自动降级**

  * 当某模型失败率 > 阈值时，自动切换备用模型
* **健康检查 API**

  * 定时运行测试流程，验证全链路可用性
* **延迟告警**

  * 如果运行时间超过设定阈值，提前预警

---

### 5. 实操案例

**案例目标**
打造一个全链路可观测的“抖音脚本生成+分发”系统：

1. 每个节点执行完成后记录日志到 MySQL
2. 失败时调用飞书告警机器人
3. 根据错误类型自动修复或人工介入
4. 每日 9 点生成一份运行报告（成功率、平均耗时、失败次数 Top3 节点）推送到飞书

---

### 6. 课后作业

1. 在你的内容生成 Flow 中给关键节点加上 Try-Catch
2. 配置一个飞书告警机器人，并在错误分支调用
3. 设置 API 超时重试机制（最多 1 次）
4. 收集一周的运行日志，分析失败原因分布
5. 写一份流程优化计划

