# 一、提示工程四要素：角色 / 目标 / 限制 / 格式

### 1) 通用提示骨架（可直接套用）

```
【角色】
你是<领域>专家，擅长<任务>，需要对<受众>输出可执行结果。

【目标】
在<时长/成本/准确性>约束下，完成：<任务定义与验收标准>。

【限制】
- 不得编造事实；未知则显式声明 "unknown"。
- 使用<语言/语气>；禁止<禁用词>；长度/字数上限<…>。
- 仅从允许来源（KB/工具）取数，且返回带引用ID。

【格式】
最终仅输出严格 JSON，不要输出多余文字。
Schema:
{
  "status": "ok|needs_info|refuse",
  "data": {...},           // 合格时填充
  "citations": [{"id": "", "span": ""}],
  "errors": []             // 不合格/缺信息写明
}
```

---

# 二、Few-shot：给模型“会什么样是合格”的样例

### 2) 正/反例对照（最有效）

```
【合格样例】
输入: 主题="夏季防晒穿搭"
输出(JSON):
{"status":"ok","data":{"title":"…","hashtags":["…"]},"citations":[{"id":"brand_style.md","span":"§2-§3"}],"errors":[]}

【不合格样例】
- 错误：输出 Markdown。
- 错误：标签>10个、缺 citations。
- 修正：严格遵守 Schema，标签≤10，所有结论需至少1条引用。
```

> 经验：1–2 个正例 + 1 个反例最稳；样例越贴近真实数据，越能稳定结构。

---

# 三、思维链可控化（不要泄露推理）

**目标**：让模型在“内部”思考，但**对外只出结构化结果**。

可用的指令模式（安全合规）：

```
- 在内部完成推理与草稿整理；不要在输出中展示思维过程。
- 如需列步骤，仅以 "rationales": ["要点1","要点2"] 概要呈现，字数≤12/项。
- 禁止输出包含“推理/思考/草稿”等敏感关键词。
```

> 注意：避免要求模型“展示详细推理过程”；使用“要点式摘要”替代。

---

# 四、结构化输出与 JSON/Schema 约束

### 1) 设计 Schema 的 7 条规范

1. **明确状态机**：`status: ok | needs_info | refuse`
2. **字段可选性**：用 `nullable` 或在 `ok` 才必填
3. **类型与范围**：`enum`/`minLength`/`maxItems`/`pattern`
4. **一致命名**：snake\_case；数组统一元素结构
5. **时间/金额**：ISO-8601 / 分单位（避免小数误差）
6. **引用位点**：`citations[].id/span` 便于溯源
7. **错误承载**：`errors[]` 收集校验失败原因

### 2) JSON Schema（示例）

```json
{
  "$schema": "https://json-schema.org/draft-07/schema#",
  "type":"object",
  "required":["status","errors"],
  "properties":{
    "status":{"type":"string","enum":["ok","needs_info","refuse"]},
    "data":{
      "type":"object",
      "properties":{
        "title":{"type":"string","maxLength":20},
        "shots":{"type":"array","items":{"type":"object","required":["scene","desc"],
          "properties":{"scene":{"type":"string"},"desc":{"type":"string","maxLength":60}}},"maxItems":6},
        "hashtags":{"type":"array","items":{"type":"string","pattern":"^#[A-Za-z0-9_]{1,20}$"},"maxItems":10}
      },
      "required":["title","hashtags"]
    },
    "citations":{"type":"array","items":{"type":"object","required":["id","span"],
      "properties":{"id":{"type":"string"},"span":{"type":"string"}}}},
    "errors":{"type":"array","items":{"type":"string"}}
  }
}
```

---

# 五、函数/工具调用（Function/Tool Use）Schema 设计

### 1) 函数签名清晰化

* **函数名**：动词开头，见名知意（`get_hot_topics`）
* **参数**：最少必要字段 + 枚举/范围校验
* **返回**：与上游 Schema 对齐，便于直通

**示例（工具元数据）**

```json
{
  "name": "get_hot_topics",
  "description": "获取平台实时热搜关键词",
  "parameters": {
    "type":"object",
    "properties":{
      "platform":{"type":"string","enum":["douyin","weibo","xiaohongshu"]},
      "limit":{"type":"integer","minimum":1,"maximum":10,"default":5},
      "lang":{"type":"string","enum":["zh","en"],"default":"zh"}
    },
    "required":["platform"]
  }
}
```

### 2) 触发规则与幂等

* 触发条件：`需要时效性关键词且KB不足`
* 幂等键：`platform+date_hour`（结合缓存）
* 失败回退：读缓存→默认模板→显式降级标记 `degraded:true`

---

# 六、实战：打造一个“可重试”的**函数调用提示模板**

> 目标：输入主题，模型先判断是否需要外部工具；如需，则以**结构化调用**形式返回；落地时由 Flow/BFF 去校验、调用与**自动重试**；失败则**带原因再生**，确保最终输出合规 JSON。

## A. System / Developer / User 三段式提示

**System（一次性）**

```
你是流程编排助手。严格遵守：
1) 仅输出 JSON，不要解释性文字。
2) 如需调用工具，输出形如：
   {"call_tool": true, "tool_name": "<name>", "arguments": {...}}
3) 完成后输出最终结果：
   {"call_tool": false, "status": "ok|needs_info|refuse", "data": {...}, "citations":[], "errors":[]}
4) 禁止泄露内部思考。
```

**Developer（约束 + Schema + 校验规则）**

```
任务：基于用户主题生成抖音脚本。必要时调用热搜工具补强素材。
工具清单(签名已注册): get_hot_topics(platform: enum, limit: 1..10, lang: enum)

输出要求：
- 当缺关键信息（platform/style）时，返回 {"status":"needs_info","errors":["missing: platform"]}。
- JSON Schema 约束（略：使用上文Schema或你实际的Schema）。
- 标题≤20字；hashtags 以 # 开头，≤10个。

调用判定规则：
- 若主题涉及“热点/趋势/今日/本周”等词，或KB相似度<0.6 → 触发 get_hot_topics(platform="douyin", limit=5)。
- 否则直接生成，无需工具。
```

**User（动态输入）**

```
主题：夏季防晒穿搭
平台：douyin
风格：funny
```

## B. 期望的两阶段输出形态

### 阶段1：决定是否调用工具

```json
{"call_tool": true, "tool_name": "get_hot_topics", "arguments": {"platform":"douyin","limit":5,"lang":"zh"}}
```

### 阶段2：拿到工具结果后再次提示（带工具返回）

**Developer（中间提示，由系统拼接）**

```
工具 get_hot_topics 返回:
{"topics":["防晒喷雾","UPF指数","防晒衣测评","物理防晒","黑科技面料"]}

请生成最终结果，必须符合 JSON Schema，仅输出 JSON。
```

**模型最终输出**

```json
{
  "call_tool": false,
  "status": "ok",
  "data": {
    "title": "3招搞定夏日UPF防晒！",
    "shots": [
      {"scene":"镜头1","desc":"户外强光，展示UPF标签与误区更正"},
      {"scene":"镜头2","desc":"喷雾/物理防晒对比，15秒时长控制"},
      {"scene":"镜头3","desc":"黑科技面料上身体验与收尾Call-to-Action"}
    ],
    "hashtags":["#UPF","#防晒衣测评","#物理防晒","#夏日穿搭","#黑科技面料"]
  },
  "citations":[{"id":"brand_style.md","span":"§2-§3"}],
  "errors":[]
}
```

## C. “可重试”机制（自动纠错闭环）

### 1) 校验器（服务端/Flow 节点）

伪代码：

```python
valid, reasons = validate(json_output, schema, rules=[
  lambda d: len(d["data"]["title"]) <= 20,
  lambda d: len(d["data"]["hashtags"]) <= 10 and all(h.startswith("#") for h in d["data"]["hashtags"])
])
if not valid:
    feedback = {"errors": reasons}
    # 触发纠错提示（见下）
```

### 2) 纠错提示（Retry Prompt）

```
你上次输出未通过校验，请仅根据以下反馈修正并重发完整 JSON：
【校验失败原因】{{reasons}}
【保留内容】除被指明的字段外，尽量保持原值不变。
【禁止】不得输出解释性文字；不得改变字段结构与数据类型。
```

> 经验：限制**重试次数=1\~2**，否则转人工/降级模板。

### 3) 失败分级与回退

* **工具失败**：读缓存 → 默认热点模板；在 JSON 中标记 `"degraded": true`
* **Schema 仍不合规**：`status="refuse"` + `errors=["schema_validation_failed"]`，交人工
* **成本/延迟超限**：切换轻量模型 + 降维输出（仅标题与 3 个标签）

---

# 七、把模板落到 Flow（节点视图）

1. **Input**（topic/platform/style）
2. **Judge Tool?**（LLM 小模型输出 `call_tool` 决策）
3. **Tool Node**（可选：get\_hot\_topics）
4. **Generate**（主 LLM，严格 JSON）
5. **Validate**（Schema + 业务规则）→ **Retry LLM**（带反馈）
6. **Post-process**（补 citations/截断标题）
7. **Output**（JSON 给前端/发布层）
8. **Log & Metrics**（tokens、重试次数、degraded 标记）

---

# 八、随取即用的微模板库

**A. 严格 JSON 输出封口**

```
仅输出一个 JSON。不要使用Markdown代码块，不要任何额外文本。
如果无法完成，输出：
{"call_tool": false, "status": "refuse", "errors": ["<原因>"]}
```

**B. 缺信息时的 needs\_info**

```
若缺少<platform>或<style>，不要编造，输出：
{"call_tool": false, "status": "needs_info", "errors": ["missing:<字段>"]}
```

**C. 函数调用触发器**

```
若需要实时数据，请返回：
{"call_tool": true, "tool_name": "<tool>", "arguments": {…}}
```

---

## 作业（可直接布置）

1. 选一个任务（如“基于主题生成抖音脚本”），用本文模板实现**工具判定→工具调用→结构化生成→校验重试**全链路。
2. 人为制造 3 种失败：

   * 标题>20字；
   * hashtags 未以 `#` 开头；
   * 漏必填字段。
     记录重试是否纠正、总延迟与 Token 成本。
3. 输出实验报告：一次通过率、重试成功率、平均延迟（含/不含重试）、成本差异；给出 3 条模板级优化建议。

